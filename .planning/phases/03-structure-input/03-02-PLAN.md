# Plan 03-02: Rust TUI VASP Integration

## Goal
Wire up the Rust TUI to call the Python VASP generation endpoints, enabling users to generate VASP inputs from Materials Project structures.

## Context
- Plan 03-01 added Python VASP utilities and RPC handlers
- Materials modal already exists with D12 generation support
- Need to add VASP generation as an alternative output format
- Use JSON-RPC thin IPC pattern (not new BridgeRequest variants)

## Tasks

### 1. Add Rust Models for VASP
**File**: `src/models.rs`

- [x] `VaspPreset` enum (relax, static, bands, dos, convergence)
- [x] `VaspGenerationConfig` struct (preset, kppra, encut)
- [x] `GeneratedVaspInputs` struct (poscar, incar, kpoints, potcar_symbols)
- [x] `StructurePreview` struct for future use

### 2. Update MaterialsSearchState
**File**: `src/state/mod.rs`

- [x] Add `vasp_config: VaspGenerationConfig` field
- [x] Update Default impl

### 3. Add VASP Request Method to App
**File**: `src/app.rs`

- [x] Add `vasp_request_id: usize` field
- [x] Add `request_generate_vasp_from_mp()` method
- [x] Send JSON-RPC request to `vasp.generate_from_mp`

### 4. Handle VASP Response
**File**: `src/app.rs` (poll_bridge_responses)

- [x] Add handler in RpcResult branch for vasp_request_id
- [x] Parse `ApiResponse<GeneratedVaspInputs>`
- [x] Combine VASP files into single editor view
- [x] Switch to Editor tab on success

### 5. Add Keybinding
**File**: `src/main.rs`

- [x] Add 'v' key in materials modal to trigger VASP generation
- [x] Keep Enter for D12 generation (backwards compatible)

## Success Criteria
- [x] Code compiles without errors
- [x] All existing tests pass
- [x] 'v' key triggers VASP generation from Materials modal
- [x] Generated VASP files appear in editor
- [x] Error handling works (pymatgen not installed)

## Verification

```bash
# Code compiles
cargo check

# Tests pass
cargo test

# Manual test: Open Materials modal, search, select, press 'v'
# Should show POSCAR, INCAR, KPOINTS in editor (requires pymatgen)
# Without pymatgen: Should show error in status bar
```

## Changes Made

### models.rs
- Added `VaspPreset` enum with Display impl
- Added `VaspGenerationConfig` struct with defaults
- `GeneratedVaspInputs` and `StructurePreview` were already present from 03-01

### state/mod.rs
- Added import for `VaspGenerationConfig`
- Added `vasp_config` field to `MaterialsSearchState`
- Updated Default impl

### app.rs
- Added `vasp_request_id` field
- Added `request_generate_vasp_from_mp()` method using JSON-RPC
- Added VASP response handler in `poll_bridge_responses()`

### main.rs
- Added 'v' keybinding in `handle_materials_modal_input()`

## Notes
- VASP generation requires pymatgen installed on Python side
- POTCAR symbols are listed but actual POTCAR must be provided separately (VASP license)
- Combined all VASP files into single text view for simplicity
- Future enhancement: Separate tabs or files for POSCAR, INCAR, KPOINTS
