# Plan 04-02: Rust TUI Job Submission

---
phase: 04-job-submission
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/models.rs
  - src/state/mod.rs
  - src/app.rs
  - src/main.rs
  - src/ui/jobs.rs
autonomous: true

must_haves:
  truths:
    - "User can submit a job from Materials modal after generating VASP inputs"
    - "User can select a cluster for job submission"
    - "Job submission shows loading state while request in flight"
    - "Submission success adds job to job list"
    - "Submission failure shows error message"
  artifacts:
    - path: "src/models.rs"
      provides: "JobSubmitRequest, JobSubmitResponse models"
      contains: "JobSubmitRequest"
    - path: "src/state/mod.rs"
      provides: "Cluster selection state, submission state"
      contains: "selected_cluster"
    - path: "src/app.rs"
      provides: "request_submit_job method, response handling"
      contains: "request_submit_job"
    - path: "src/main.rs"
      provides: "'s' keybinding for job submission"
      contains: "KeyCode::Char('s')"
  key_links:
    - from: "src/main.rs"
      to: "src/app.rs"
      via: "request_submit_job() call on 's' key"
      pattern: "request_submit_job\\(\\)"
    - from: "src/app.rs"
      to: "IPC jobs.submit"
      via: "JSON-RPC call"
      pattern: "jobs\\.submit"
---

<objective>
Add job submission capability to the Rust TUI, allowing users to submit VASP calculations from the Materials modal.

Purpose: Close the loop from structure search -> VASP generation -> job submission in a single workflow.

Output: New models for job submission, cluster selection state, keybindings, and IPC call to Python backend.
</objective>

<execution_context>
@/Users/briansquires/.claude/get-shit-done/workflows/execute-plan.md
@/Users/briansquires/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-job-submission/04-RESEARCH.md
@src/models.rs
@src/state/mod.rs
@src/app.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Job Submission Models</name>
  <files>src/models.rs</files>
  <action>
Add new models for job submission request/response:

```rust
/// Request to submit a job via quacc recipe.
#[derive(Debug, Clone, Serialize)]
pub struct JobSubmitRequest {
    /// Full recipe path (e.g., "quacc.recipes.vasp.core.relax_job")
    pub recipe: String,
    /// Structure as POSCAR string
    pub structure: String,
    /// Cluster name from clusters.json (optional, "local" if None)
    #[serde(skip_serializing_if = "Option::is_none")]
    pub cluster: Option<String>,
    /// Recipe parameters (kpts, encut, etc.)
    #[serde(default)]
    pub params: serde_json::Value,
}

/// Response from jobs.submit RPC.
#[derive(Debug, Clone, Deserialize)]
pub struct JobSubmitResponse {
    /// Assigned job ID (UUID)
    pub job_id: Option<String>,
    /// Initial status ("pending" or "error")
    pub status: String,
    /// Error message if submission failed
    #[serde(default)]
    pub error: Option<String>,
}

/// Response from jobs.status RPC.
#[derive(Debug, Clone, Deserialize)]
pub struct JobStatusResponse {
    pub job_id: String,
    pub status: String,  // "pending", "running", "completed", "failed", "cancelled"
    #[serde(default)]
    pub error: Option<String>,
    #[serde(default)]
    pub result: Option<JobResultSummary>,
}

/// Summary of completed job results.
#[derive(Debug, Clone, Default, Deserialize)]
pub struct JobResultSummary {
    #[serde(default)]
    pub energy_ev: Option<f64>,
    #[serde(default)]
    pub max_force_ev_ang: Option<f64>,
    #[serde(default)]
    pub formula: Option<String>,
    #[serde(default)]
    pub work_dir: Option<String>,
}
```

Add unit tests for serialization/deserialization.
  </action>
  <verify>
```bash
cd /Users/briansquires/CRYSTAL23/crystalmath
cargo test models::tests::test_job_submit --no-fail-fast
```
  </verify>
  <done>JobSubmitRequest, JobSubmitResponse, JobStatusResponse, JobResultSummary models compile and serialize correctly</done>
</task>

<task type="auto">
  <name>Task 2: Add Submission State and App Methods</name>
  <files>
    src/state/mod.rs
    src/app.rs
  </files>
  <action>
**state/mod.rs - Add to MaterialsSearchState:**
```rust
/// Selected cluster for submission (index into clusters list)
pub selected_cluster_idx: usize,
/// Whether a submission request is in flight
pub submitting: bool,
/// Last submission error
pub submit_error: Option<String>,
/// Last submitted job ID (for success feedback)
pub last_submitted_job_id: Option<String>,
```

Add methods:
- `cycle_cluster(&mut self, max: usize)` - Cycle selected cluster index
- `start_submit(&mut self)` - Set submitting = true, clear error
- `submit_success(&mut self, job_id: String)` - Set last_submitted_job_id, submitting = false
- `submit_failure(&mut self, error: String)` - Set submit_error, submitting = false

**app.rs - Add submission request tracking:**
```rust
// In App struct
submit_request_id: usize,

// Add method
pub fn request_submit_job(&mut self) {
    // Check we have generated VASP content
    if self.materials_state.preview.is_none() {
        self.set_error("No structure selected");
        return;
    }

    // Get POSCAR from last generated VASP (need to track this)
    // Build JobSubmitRequest with:
    // - recipe: "quacc.recipes.vasp.core.relax_job" (or based on preset)
    // - structure: POSCAR content
    // - cluster: selected cluster name if any
    // - params: from vasp_config (preset, kppra, encut)

    // Increment request ID
    self.submit_request_id += 1;

    // Send JSON-RPC request
    // ... (follow pattern from request_generate_vasp_from_mp)

    self.materials_state.start_submit();
}
```

In `poll_bridge_responses()`, add handler for submit response:
- Parse `ApiResponse<JobSubmitResponse>`
- On success: Call `submit_success(job_id)`, optionally refresh job list
- On error: Call `submit_failure(error)`
  </action>
  <verify>
```bash
cd /Users/briansquires/CRYSTAL23/crystalmath
cargo check
```
  </verify>
  <done>MaterialsSearchState has cluster selection and submission state, App has request_submit_job method</done>
</task>

<task type="auto">
  <name>Task 3: Add Keybinding and UI Updates</name>
  <files>
    src/main.rs
    src/ui/materials.rs
  </files>
  <action>
**main.rs - Add keybinding in handle_materials_modal_input():**

When materials modal is open and a structure is selected with VASP generated:
- 's' key: Call `app.request_submit_job()`
- 'c' key: Cycle cluster selection (app.materials_state.cycle_cluster())

Add handling in the match for KeyCode::Char:
```rust
KeyCode::Char('s') if !app.materials_state.submitting => {
    app.request_submit_job();
}
KeyCode::Char('c') => {
    // Get cluster count from cached clusters
    let max = app.quacc_clusters.len();
    if max > 0 {
        app.materials_state.cycle_cluster(max);
    }
}
```

**ui/materials.rs - Update button hints:**

In the preview panel, add hints for:
- "[s] Submit Job" - if VASP is generated and not submitting
- "[c] Cluster: {name}" - show selected cluster
- "Submitting..." - if submission in progress

Add cluster selection display in preview panel footer:
```rust
if !clusters.is_empty() {
    let cluster_name = &clusters[state.selected_cluster_idx].name;
    hints.push(format!("[c] Cluster: {}", cluster_name));
}
```

Show submission status/error:
- If submitting: Show spinner or "Submitting..."
- If submit_error: Show error in red
- If last_submitted_job_id: Show "Submitted: {job_id}" briefly
  </action>
  <verify>
```bash
cd /Users/briansquires/CRYSTAL23/crystalmath
cargo build
cargo test
```
  </verify>
  <done>'s' key triggers job submission, 'c' cycles cluster, UI shows submission state</done>
</task>

</tasks>

<verification>
```bash
cd /Users/briansquires/CRYSTAL23/crystalmath

# Code compiles
cargo check

# Tests pass
cargo test

# Manual verification (requires running server):
# 1. Launch TUI
# 2. Open Materials modal (m)
# 3. Search for a structure
# 4. Generate VASP (v)
# 5. Press 'c' to cycle clusters
# 6. Press 's' to submit
# 7. Observe status in UI
```
</verification>

<success_criteria>
- [ ] JobSubmitRequest serializes correctly for JSON-RPC
- [ ] JobSubmitResponse/JobStatusResponse deserialize from Python response
- [ ] MaterialsSearchState tracks cluster selection and submission state
- [ ] 's' key triggers request_submit_job() when VASP is generated
- [ ] 'c' key cycles through available clusters
- [ ] UI shows current cluster selection
- [ ] UI shows submission in progress state
- [ ] Submission errors display in UI
- [ ] All existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-job-submission/04-02-SUMMARY.md`
</output>
