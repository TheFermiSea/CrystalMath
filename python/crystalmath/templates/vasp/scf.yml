name: "VASP SCF"
version: "1.0"
description: "Self-consistent field calculation with VASP"
author: "Crystal-TUI Team"
dft_code: "vasp"
tags: ["vasp", "scf", "energy"]
multi_file: true

parameters:
  system:
    type: "string"
    default: "VASP Calculation"
    description: "System description"
    required: true

  # INCAR parameters
  prec:
    type: "select"
    options: ["Normal", "Accurate", "High", "Low", "Medium"]
    default: "Accurate"
    description: "Precision mode"
    required: true

  encut:
    type: "float"
    description: "Plane wave energy cutoff (eV). If not set, uses POTCAR default * 1.3"

  ismear:
    type: "select"
    options:
      - label: "Gaussian (0)"
        value: "0"
      - label: "Methfessel-Paxton (1)"
        value: "1"
      - label: "Tetrahedron (-5)"
        value: "-5"
      - label: "Fermi (-1)"
        value: "-1"
    default: "0"
    description: "Smearing method"

  sigma:
    type: "float"
    default: 0.05
    min: 0.01
    max: 0.5
    description: "Smearing width (eV)"

  ediff:
    type: "float"
    default: 1.0e-6
    min: 1.0e-9
    max: 1.0e-4
    description: "SCF convergence criterion (eV)"
    required: true

  nelm:
    type: "integer"
    default: 100
    min: 10
    max: 500
    description: "Maximum SCF steps"

  algo:
    type: "select"
    options: ["Normal", "Fast", "VeryFast", "All", "Damped"]
    default: "Normal"
    description: "Electronic minimization algorithm"

  lreal:
    type: "select"
    options: [".FALSE.", "Auto", "On"]
    default: "Auto"
    description: "Real space projection"

  lwave:
    type: "boolean"
    default: true
    description: "Write WAVECAR"

  lcharg:
    type: "boolean"
    default: true
    description: "Write CHGCAR"

  ispin:
    type: "select"
    options:
      - label: "Non-spin-polarized (1)"
        value: "1"
      - label: "Spin-polarized (2)"
        value: "2"
    default: "1"
    description: "Spin polarization"

  lorbit:
    type: "integer"
    default: 0
    description: "LORBIT for DOS/projected characters (0=off, 10=DOSCAR, 11=lm-decomposed)"

  # KPOINTS parameters
  kpoints_type:
    type: "select"
    options: ["automatic", "gamma", "monkhorst"]
    default: "automatic"
    description: "K-point generation scheme"

  kpoints_grid:
    type: "string"
    default: "4 4 4"
    description: "K-point grid (nk1 nk2 nk3)"
    required: true

  kpoints_shift:
    type: "string"
    default: "0 0 0"
    description: "K-point shift"

  # Structure (POSCAR content)
  poscar_content:
    type: "text"
    description: "POSCAR file content"
    required: true

  # Pseudopotentials (POTCAR info)
  potcar_elements:
    type: "multiselect"
    description: "Elements in order (for POTCAR concatenation)"
    required: true

files:
  INCAR: incar_template
  KPOINTS: kpoints_template
  POSCAR: poscar_template

incar_template: |
  SYSTEM = {{ system }}
  PREC = {{ prec }}
  {% if encut %}
  ENCUT = {{ encut }}
  {% endif %}
  ISMEAR = {{ ismear }}
  SIGMA = {{ sigma }}
  EDIFF = {{ ediff }}
  NELM = {{ nelm }}
  ALGO = {{ algo }}
  LREAL = {{ lreal }}
  LWAVE = {{ '.TRUE.' if lwave else '.FALSE.' }}
  LCHARG = {{ '.TRUE.' if lcharg else '.FALSE.' }}
  ISPIN = {{ ispin }}
  {% if lorbit > 0 %}
  LORBIT = {{ lorbit }}
  {% endif %}
  # Additional settings
  NCORE = 4
  KPAR = 1

kpoints_template: |
  {{ kpoints_type | capitalize }} mesh
  0
  {{ 'Gamma' if kpoints_type == 'gamma' else 'Monkhorst-Pack' }}
  {{ kpoints_grid }}
  {{ kpoints_shift }}

poscar_template: |
  {{ poscar_content }}
