# RabbitMQ Configuration for AiiDA
# =================================
# Optimized for single-machine development/testing with AiiDA workflows.
# This file is mounted to /etc/rabbitmq/conf.d/99-aiida.conf
#
# Reference: https://www.rabbitmq.com/configure.html

# =============================================================================
# Memory Management
# =============================================================================

# Memory high watermark (fraction of available RAM)
# AiiDA workflows can generate many messages; allow generous memory
vm_memory_high_watermark.relative = 0.6

# Memory high watermark paging ratio
# Start paging messages to disk when memory exceeds this fraction of watermark
vm_memory_high_watermark_paging_ratio = 0.75

# =============================================================================
# Disk Management
# =============================================================================

# Minimum free disk space before RabbitMQ stops accepting messages
# Set to 1GB for development; increase in production
disk_free_limit.absolute = 1GB

# =============================================================================
# Connection Settings
# =============================================================================

# Maximum number of channels per connection
# AiiDA uses multiple channels for concurrent operations
channel_max = 128

# Heartbeat timeout (seconds)
# Detect dead connections; 60s is a good balance
heartbeat = 60

# =============================================================================
# Queue Settings
# =============================================================================

# Default queue type (quorum queues are more resilient but heavier)
# Classic queues are sufficient for single-node development
# default_queue_type = classic

# Consumer timeout (milliseconds) - disabled for long-running AiiDA tasks
# AiiDA calculations can take hours; disable timeout
consumer_timeout = 3600000

# =============================================================================
# Management Plugin
# =============================================================================

# Management plugin is enabled via the rabbitmq:management image
# Access at http://localhost:15672 (or RABBITMQ_MANAGEMENT_PORT)

# Rate mode for statistics
management.rates_mode = basic

# Statistics collection interval (milliseconds)
collect_statistics_interval = 5000

# =============================================================================
# Logging
# =============================================================================

# Console logging
log.console = true
log.console.level = info

# File logging (inside container)
log.file = /var/log/rabbitmq/rabbit.log
log.file.level = info
log.file.rotation.date = $D0
log.file.rotation.count = 7

# =============================================================================
# Networking
# =============================================================================

# Listen on all interfaces (container networking)
listeners.tcp.default = 5672

# TCP connection backlog
tcp_listen_options.backlog = 128

# TCP keepalive to detect dead connections
tcp_listen_options.keepalive = true

# =============================================================================
# Security
# =============================================================================

# Loopback users (allow default user only from localhost)
# Disabled for Docker networking where connections come from bridge network
loopback_users = none
