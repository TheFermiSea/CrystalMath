name: "YAMBO BSE Optical Absorption"
version: "1.0"
description: "Bethe-Salpeter Equation for excitonic optical absorption"
author: "Crystal-TUI Team"
dft_code: "yambo"
tags: ["yambo", "bse", "optics", "exciton", "absorption"]
container_enabled: true

parameters:
  # Band ranges for excitons
  bse_bands_min:
    type: "integer"
    default: 20
    description: "Lowest band for BSE (typically valence bands)"
    required: true

  bse_bands_max:
    type: "integer"
    default: 80
    description: "Highest band for BSE (including conduction)"
    required: true

  # Cutoffs
  exchange_cutoff:
    type: "float"
    default: 30.0
    min: 10.0
    max: 100.0
    description: "Exchange cutoff BSENGexx (Ry)"
    required: true

  correlation_cutoff:
    type: "float"
    default: 2.0
    min: 0.5
    max: 10.0
    description: "Correlation/W cutoff BSENGBlk (Ry)"
    required: true

  # Energy range for spectrum
  energy_min:
    type: "float"
    default: 0.0
    description: "Minimum photon energy (eV)"

  energy_max:
    type: "float"
    default: 6.0
    min: 1.0
    max: 20.0
    description: "Maximum photon energy (eV)"
    required: true

  energy_steps:
    type: "integer"
    default: 500
    min: 100
    max: 2000
    description: "Number of energy points"

  # Broadening
  broadening:
    type: "float"
    default: 0.05
    min: 0.01
    max: 0.5
    description: "Lorentzian broadening (eV)"

  # BSE mode
  bse_mode:
    type: "select"
    options:
      - label: "Resonant only"
        value: "resonant"
      - label: "With coupling"
        value: "coupling"
    default: "resonant"
    description: "BSE approximation (resonant is faster)"

  # Kernel
  kernel_mode:
    type: "select"
    options:
      - label: "Screened Exchange (SEX)"
        value: "SEX"
      - label: "Hartree-Fock (HF)"
        value: "HF"
    default: "SEX"
    description: "BSE kernel type"

  # Solver
  solver:
    type: "select"
    options:
      - label: "Haydock iterative (h)"
        value: "h"
      - label: "Direct diagonalization (d)"
        value: "d"
    default: "h"
    description: "BSE solver (Haydock is faster for large systems)"

  solver_iterations:
    type: "integer"
    default: 500
    min: 100
    max: 2000
    description: "Max Haydock iterations"

  # Light polarization
  polarization_x:
    type: "float"
    default: 1.0
    description: "Polarization x-component"

  polarization_y:
    type: "float"
    default: 0.0
    description: "Polarization y-component"

  polarization_z:
    type: "float"
    default: 0.0
    description: "Polarization z-component"

  # Output property
  property:
    type: "select"
    options:
      - label: "Absorption"
        value: "abs"
      - label: "Kerr effect"
        value: "kerr"
      - label: "Magneto-optic"
        value: "magn"
    default: "abs"
    description: "Optical property to compute"

  # Job name
  job_name:
    type: "string"
    default: "bse"
    description: "Output job name for YAMBO"

  # Use GW corrections
  use_gw:
    type: "boolean"
    default: true
    description: "Apply GW quasiparticle corrections"

files:
  yambo.in: yambo_input_template

yambo_input_template: |
  # BSE Optical Absorption Calculation
  # Generated by Crystal-TUI

  bse                        # Enable BSE
  optics                     # Compute optical properties

  # BSE configuration
  BSEmod = "{{ bse_mode }}"      # {{ 'Resonant only' if bse_mode == 'resonant' else 'With coupling' }}
  BSKmod = "{{ kernel_mode }}"          # {{ 'Screened exchange' if kernel_mode == 'SEX' else 'Hartree-Fock' }} kernel

  # Cutoffs
  BSENGBlk= {{ correlation_cutoff }} Ry         # Correlation (W) cutoff
  BSENGexx= {{ exchange_cutoff }} Ry         # Exchange cutoff

  # Band range for excitons
  %BSEBands
    {{ bse_bands_min }} | {{ bse_bands_max }}
  %

  # Solver configuration
  BSSmod = "{{ solver }}"              # {{ 'Haydock iterative' if solver == 'h' else 'Direct diagonalization' }}
  {% if solver == 'h' %}
  BSSNIter = {{ solver_iterations }}          # Max Haydock iterations
  {% endif %}

  # Energy range for spectrum
  %BEnRange
   {{ energy_min }} | {{ energy_max }} | eV
  %
  BEnSteps= {{ energy_steps }}           # Energy resolution

  # Broadening
  BDmRange= {{ broadening }} | {{ broadening }} eV

  # Light polarization direction
  %BLongDir
   {{ polarization_x }} | {{ polarization_y }} | {{ polarization_z }}
  %

  # Output property
  BSSProp = "{{ property }}"          # {{ property | capitalize }} spectrum

execution:
  command: "yambo -F yambo.in -J {{ job_name }} -o b"
  container: "yambo_5.2.0_gpu.sif"
  gpu_required: false
  required_files:
    - "SAVE"
    - "{% if use_gw %}ndb.QP{% endif %}"
