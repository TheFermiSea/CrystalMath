name: "YAMBO Shift Current (Bulk Photovoltaic)"
version: "1.0"
description: "Non-linear shift current calculation for bulk photovoltaic effect"
author: "Crystal-TUI Team"
dft_code: "yambo"
tags: ["yambo", "shift-current", "bpve", "nonlinear", "optics"]
container_enabled: true

parameters:
  # Band range
  nl_bands_min:
    type: "integer"
    default: 1
    description: "Lowest band for non-linear calculation"
    required: true

  nl_bands_max:
    type: "integer"
    default: 200
    description: "Highest band for non-linear calculation"
    required: true

  # Photon energy range
  energy_min:
    type: "float"
    default: 0.5
    min: 0.0
    description: "Minimum photon energy (eV)"
    required: true

  energy_max:
    type: "float"
    default: 4.0
    min: 0.5
    max: 10.0
    description: "Maximum photon energy (eV)"
    required: true

  energy_steps:
    type: "integer"
    default: 200
    min: 50
    max: 1000
    description: "Number of photon energy points"

  # Broadening (lifetime)
  damping:
    type: "float"
    default: 0.05
    min: 0.01
    max: 0.5
    description: "Broadening/damping (eV)"
    required: true

  # Electric field direction
  field_x:
    type: "float"
    default: 1.0
    description: "Field direction x-component"

  field_y:
    type: "float"
    default: 0.0
    description: "Field direction y-component"

  field_z:
    type: "float"
    default: 0.0
    description: "Field direction z-component"

  # Field intensity
  field_intensity:
    type: "float"
    default: 1000.0
    min: 1.0
    max: 100000.0
    description: "Field intensity (kW/m^2)"

  # Time propagation
  total_time:
    type: "float"
    default: 50.0
    min: 10.0
    max: 500.0
    description: "Total propagation time (fs)"

  integration_time:
    type: "float"
    default: 10.0
    min: 1.0
    max: 100.0
    description: "Integration time for current (fs)"

  time_step:
    type: "float"
    default: 0.002
    min: 0.001
    max: 0.1
    description: "Time step (fs)"

  # Correlation level
  correlation:
    type: "select"
    options:
      - label: "Independent Particle (IPA)"
        value: "IPA"
      - label: "Hartree"
        value: "HARTREE"
      - label: "Long-range Coulomb (LRC)"
        value: "LRC"
    default: "IPA"
    description: "Correlation level (IPA is fastest)"

  # Output type
  output:
    type: "select"
    options:
      - label: "Current"
        value: "current"
      - label: "Polarization"
        value: "polarization"
    default: "current"
    description: "Output quantity"

  # Job name
  job_name:
    type: "string"
    default: "shift"
    description: "Output job name for YAMBO"

files:
  yambo.in: yambo_input_template

yambo_input_template: |
  # Shift Current (Bulk Photovoltaic Effect) Calculation
  # Generated by Crystal-TUI
  #
  # IMPORTANT: Run ypp_nl -y first to reduce symmetries
  # (electric field breaks crystal symmetry)

  nl                         # Non-linear optics
  shiftc                     # Shift current calculation

  # Band range
  %NLBands
   {{ nl_bands_min }} | {{ nl_bands_max }}
  %

  # Photon energy range
  %NLEnRange
   {{ energy_min }} | {{ energy_max }} | eV
  %
  NLEnSteps= {{ energy_steps }}          # Energy points

  # Lifetime broadening
  NLDamping= {{ damping }} eV

  # Electric field configuration
  %Field1_Dir
   {{ field_x }} | {{ field_y }} | {{ field_z }}
  %
  Field1_Int= {{ field_intensity }} kWLm2

  # Time propagation parameters
  NLTime= {{ total_time }} fs             # Total propagation time
  NLIntTime= {{ integration_time }} fs          # Integration time for current
  NLstep= {{ time_step }} fs             # Time step

  # Correlation level
  NLCorrelation= "{{ correlation }}"   # {{ correlation }}

  # Output
  NLoutput= "{{ output }}"        # {{ output | capitalize }} output

execution:
  # Use yambo_nl for non-linear calculations
  command: "yambo_nl -F yambo.in -J {{ job_name }}"
  container: "yambo_5.2.0_gpu.sif"
  gpu_required: false
  required_files:
    - "SAVE"
  pre_commands:
    # Reduce symmetries for electric field
    - "ypp_nl -y"

notes: |
  Shift Current Notes:
  - Non-centrosymmetric materials only (needs broken inversion symmetry)
  - DC shift current is the omega->0 limit
  - Use dense k-mesh without symmetry reduction for accuracy
  - Field direction should match crystal axes for clean tensor elements
  - Output files: o-*.YPP-SC* (shift current tensor)
